<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ESP32 Device Files</title>
	<!-- Materialize CSS -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<style>
		html,
		body {
			height: 100%;
			margin: 0;
			padding: 0;
		}

		body {
			display: flex;
			flex-direction: column;
			min-height: 100vh;
			padding: 16px;
			box-sizing: border-box;
		}

		#main-content {
			flex: 1 1 auto;
			display: flex;
			flex-direction: column;
		}

		#console {
			background-color: black;
			color: white;
			overflow: auto;
			padding: 8px;
			border-radius: 4px;
			flex: 1 1 auto;
			min-height: 120px;
			max-height: 50vh;
		}

		.loader {
			display: flex;
			justify-content: center;
			align-items: center;
			height: 80px;
		}

		table {
			font-size: 16px;
		}

		.nav-wrapper {
			padding-left: 20px;
		}
	</style>
</head>

<body>
	<div class="row">
		<div class="col s12">
			<button id="uploadBtn" class="waves-effect waves-light btn blue">Upload</button>
			<button id="deleteBtn" class="waves-effect waves-light btn red">Delete</button>
			<button id="reloadBtn" class="waves-effect waves-light btn grey">Reload</button>
			<button id="resetBtn" class="waves-effect waves-light btn orange">Reset</button>
			<button id="createFolderBtn" class="waves-effect waves-light btn green">
				<i class="material-icons left">create_new_folder</i>Create Folder
			</button>

			<div class="input-field inline" style="display: none; margin: 0px;">
				<select id="exampleDropdown" class="browser-default">
					<option value="">Select example file...</option>
					<option value="animation.py">animation.py</option>
					<option value="scanI2C.py">scanI2C.py</option>
					<option value="servo.py">servo.py</option>
					<option value="test.py">test.py</option>
					<option value="touch.py">touch.py</option>
				</select>
			</div>
		</div>
	</div>
	<div id="main-content">
		<!-- <h4 style="margin: 0px;">Files on device</h4> -->
		<nav>
			<div class="nav-wrapper">
				<div id="breadcrumbDiv" class="col s12">
				</div>
			</div>
		</nav>
		<div id="loader" class="loader"></div>
		<div id="files"></div>
		<img src="image/hkpsLogo.png" style="height: 20px;" />
	</div>
	<!-- Materialize Modal for confirmation -->
	<div id="createFolderModal" class="modal">
		<div class="modal-content">
			<h5>Create New Folder</h5>
			<div class="input-field">
				<input id="createFolderInput" type="text" placeholder="Folder name">
			</div>
		</div>
		<div class="modal-footer">
			<a href="#!" id="createFolderYesBtn" class="modal-close waves-effect waves-green btn-flat">Create</a>
			<a href="#!" id="createFolderNoBtn" class="modal-close waves-effect waves-red btn-flat">Cancel</a>
		</div>
	</div>
	<div id="confirmModal" class="modal">
		<div class="modal-content">
			<h5 id="confirmMessage">Are you sure?</h5>
		</div>
		<div class="modal-footer">
			<a href="#!" id="confirmYesBtn" class="modal-close waves-effect waves-green btn-flat">Yes</a>
			<a href="#!" id="confirmNoBtn" class="modal-close waves-effect waves-red btn-flat">No</a>
		</div>
	</div>

	<script>
		const vscode = window.acquireVsCodeApi();

		document.getElementById('uploadBtn').onclick = () => {
			vscode.postMessage({ command: 'upload' });
			alert('Upload button clicked!');
		};
		document.getElementById('deleteBtn').onclick = () => {
			deleteFiles();
		};
		document.getElementById('reloadBtn').onclick = () => {
			vscode.postMessage({ command: 'reload' });
		};
		document.getElementById('resetBtn').onclick = () => {
			vscode.postMessage({ command: 'reset' });
		};
		document.getElementById('exampleDropdown').onchange = function () {
			const fname = this.value;
			if (fname) {
				vscode.postMessage({ command: 'openExampleFile', filename: fname });
			}
		};
		document.getElementById('createFolderBtn').onclick = function () {
			const modalElem = document.getElementById('createFolderModal');
			const modalInstance = M.Modal.init(modalElem, { dismissible: true });
			document.getElementById('createFolderInput').value = '';
			modalInstance.open();
			document.getElementById('createFolderYesBtn').onclick = function () {
				const folderName = document.getElementById('createFolderInput').value;
				if (folderName && folderName.trim()) {
					vscode.postMessage({ command: 'createFolder', folderName: folderName.trim() });
				}
			};
			document.getElementById('createFolderNoBtn').onclick = function () {
				modalInstance.close();
			};
		};

		// Listen for messages from the extension
		window.addEventListener('message', event => {
			const message = event.data;
			if (message.command === 'showFiles') {
				document.getElementById('loader').style.display = 'none';
				document.getElementById('files').innerHTML = message.html;
				const table = document.getElementById('filesTable');
				if (table) {
					table.addEventListener('click', function (e) {
						const td = e.target.closest('td[data-fname]');
						if (td) {
							window.parent.postMessage({ command: 'openFile', filename: td.getAttribute('data-fname') }, '*');
						}
					});
				}
			} else if (message.command === 'console') {
				const consoleDiv = document.getElementById('console');
				if (consoleDiv) {
					consoleDiv.innerText += message.text + '\n';
					consoleDiv.scrollTop = consoleDiv.scrollHeight;
				}
			} else if (message.command === 'setImageUri' && message.uri) {
				/*document.body.insertAdjacentHTML('beforeend',
					`<a id="hkps-link" href="https://www.hkprog.org" target="_blank" rel="noopener" style="padding: 10px;">
						<img id="hkps-img" src="${message.uri}" alt="HKPS Eng Big Blue" style="position:fixed;bottom:24px;right:24px;width:200px;height:auto;" />
					</a>`
				);*/
			} else if (message.command === 'setImageUri2' && message.uri) {
				/*document.body.insertAdjacentHTML('beforeend',
					`<a id="hkps-link" href="https://semiblock.hkprog.org" target="_blank" rel="noopener" style="padding: 10px;">
						<img id="hkps-img" src="${message.uri}" alt="Semiblock" style="position:fixed;bottom:24px;right:250px;height:80px;" />
					</a>`
				);*/
				// document.body.insertAdjacentHTML('beforeend',
				// 	`<a id="hkps-link" href="https://semiblock.hkprog.org" target="_blank" rel="noopener" style="padding: 10px;">
				// 		<img id="hkps-img" src="assets/image/semiblock.svg" alt="Semiblock" style="position:fixed;bottom:24px;right:250px;height:80px;" />
				// 	</a>`
				// );
			} else if (message.command === 'renderBreadcrumb') {
				const breadcrumb = document.querySelector('#breadcrumbDiv');
				if (breadcrumb) {
					breadcrumb.innerHTML = '';
					const parts = message.currentFolder.split('/').filter(Boolean);
					let pathSoFar = '';
					// Add root
					const rootItem = document.createElement('a');
					rootItem.className = 'breadcrumb';
					rootItem.textContent = '/';
					rootItem.style.cursor = 'pointer';
					rootItem.onclick = () => {
						vscode.postMessage({ command: 'changeFolder', folder: '/' });
						vscode.postMessage({ command: 'reload' });
					};
					breadcrumb.appendChild(rootItem);
					// Add each folder part
					parts.forEach((part, index) => {
						pathSoFar += '/' + part;
						const item = document.createElement('a');
						item.className = 'breadcrumb';
						item.textContent = part;
						item.style.cursor = 'pointer';

						let temp = pathSoFar;
						if (index !== parts.length - 1) {
							item.onclick = () => {
								vscode.postMessage({ command: 'changeFolder', folder: temp });
								vscode.postMessage({ command: 'reload' });
							};
						}
						breadcrumb.appendChild(item);
					});
				}
			}
		});

		function tableClicked(filename) {
			vscode.postMessage({ command: 'openFile', filename });
		}

		// Show custom rename modal
		function renameFile(filename) {
			showRenameModal(filename, (newName) => {
				if (newName && newName !== filename) {
					vscode.postMessage({ command: 'renameFile', oldName: filename, newName });
				}
			});
		}

		function deleteFiles() {
			const selectedFiles = Array.from(document.querySelectorAll('#filesTable input[type="checkbox"]:checked'))
				.map(checkbox => checkbox.getAttribute('data-fname'));
			if (selectedFiles.length === 0) {
				showConfirm('No files selected for deletion.', null, null);
				return;
			}
			showConfirm(
				`Are you sure you want to delete the following files?\n\n${selectedFiles.join('\n')}`,
				() => vscode.postMessage({ command: 'deleteFile', files: selectedFiles }),
				() => { }
			);
		}

		// Show Materialize confirmation modal
		function showConfirm(message, onYes, onNo) {
			document.getElementById('confirmMessage').textContent = message;
			const modalElem = document.getElementById('confirmModal');
			const modalInstance = M.Modal.init(modalElem, { dismissible: false });
			modalInstance.open();
			const yesBtn = document.getElementById('confirmYesBtn');
			const noBtn = document.getElementById('confirmNoBtn');
			yesBtn.onclick = () => {
				modalInstance.close();
				if (onYes) onYes();
			};
			noBtn.onclick = () => {
				modalInstance.close();
				if (onNo) onNo();
			};
		}

		// Custom modal for renaming files (unchanged)
		function showRenameModal(filename, onRename) {
			let modal = document.getElementById('renameModal');
			if (!modal) {
				modal = document.createElement('div');
				modal.id = 'renameModal';
				modal.style.position = 'fixed';
				modal.style.top = '0';
				modal.style.left = '0';
				modal.style.width = '100vw';
				modal.style.height = '100vh';
				modal.style.background = 'rgba(0,0,0,0.3)';
				modal.style.zIndex = '1001';
				modal.style.display = 'flex';
				modal.style.justifyContent = 'center';
				modal.style.alignItems = 'center';
				modal.innerHTML = `
					<div style="background:#fff;padding:24px;border-radius:8px;min-width:300px;box-shadow:0 2px 8px #0002;text-align:center;">
						<div style="margin-bottom:16px;">Rename <b>${filename}</b> to:</div>
						<input id="renameInput" type="text" value="${filename}" style="width:80%;padding:8px;margin-bottom:16px;" />
						<br />
						<button id="renameYesBtn" style="margin-right:16px;">Rename</button>
						<button id="renameNoBtn">Cancel</button>
					</div>
				`;
				document.body.appendChild(modal);
			} else {
				modal.style.display = 'flex';
				modal.querySelector('#renameInput').value = filename;
			}
			const yesBtn = modal.querySelector('#renameYesBtn');
			const noBtn = modal.querySelector('#renameNoBtn');
			yesBtn.onclick = () => {
				const newName = modal.querySelector('#renameInput').value;
				modal.style.display = 'none';
				if (onRename) onRename(newName);
			};
			noBtn.onclick = () => {
				modal.style.display = 'none';
			};
		}

		// Initialize Materialize select and modal on DOMContentLoaded
		document.addEventListener('DOMContentLoaded', function () {
			var elems = document.querySelectorAll('select');
			M.FormSelect.init(elems);
			var modals = document.querySelectorAll('.modal');
			M.Modal.init(modals);
		});
	</script>
</body>

</html>