<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ESP32 Device Files</title>
	<!-- Materialize CSS -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<style>
		html,
		body {
			height: 100%;
			margin: 0;
			padding: 0;
		}

		body {
			display: flex;
			flex-direction: column;
			min-height: 100vh;
			padding: 16px;
			box-sizing: border-box;
		}

		#main-content {
			flex: 1 1 auto;
			display: flex;
			flex-direction: column;
		}

		#console {
			background-color: black;
			color: white;
			overflow: auto;
			padding: 8px;
			border-radius: 4px;
			flex: 1 1 auto;
			min-height: 120px;
			max-height: 50vh;
		}

		.loader {
			display: flex;
			justify-content: center;
			align-items: center;
			height: 80px;
		}

		table {
			font-size: 16px;
		}

		.nav-wrapper {
			padding-left: 20px;
		}
	</style>
</head>

<body>
	<div class="row">
		<div class="col s12">
			<button id="uploadBtn" class="waves-effect waves-light btn blue">Upload</button>
			<button id="deleteBtn" class="waves-effect waves-light btn red">Delete</button>
			<button id="reloadBtn" class="waves-effect waves-light btn grey">Reload</button>
			<button id="resetBtn" class="waves-effect waves-light btn orange">Reset</button>
			<button id="createFolderBtn" class="waves-effect waves-light btn green">
				<i class="material-icons left">create_new_folder</i>Create Folder
			</button>

			<div class="input-field inline" style="display: none; margin: 0px;">
				<select id="exampleDropdown" class="browser-default">
					<option value="">Select example file...</option>
					<option value="animation.py">animation.py</option>
					<option value="scanI2C.py">scanI2C.py</option>
					<option value="servo.py">servo.py</option>
					<option value="test.py">test.py</option>
					<option value="touch.py">touch.py</option>
				</select>
			</div>
		</div>
	</div>
	<div id="main-content">
		<!-- <h4 style="margin: 0px;">Files on device</h4> -->
		<nav>
			<div class="nav-wrapper">
				<div id="breadcrumbDiv" class="col s12">
				</div>
			</div>
		</nav>
		<div id="loader" class="loader"></div>
		<div id="files"></div>
		<h4>Console</h4>
		<div id="console"></div>
	</div>
	<!-- Materialize Modal for confirmation -->
	<div id="createFolderModal" class="modal">
		<div class="modal-content">
			<h5>Create New Folder</h5>
			<div class="input-field">
				<input id="createFolderInput" type="text" placeholder="Folder name">
			</div>
		</div>
		<div class="modal-footer">
			<a href="#!" id="createFolderYesBtn" class="modal-close waves-effect waves-green btn-flat">Create</a>
			<a href="#!" id="createFolderNoBtn" class="modal-close waves-effect waves-red btn-flat">Cancel</a>
		</div>
	</div>
	<div id="confirmModal" class="modal">
		<div class="modal-content">
			<h5 id="confirmMessage">Are you sure?</h5>
		</div>
		<div class="modal-footer">
			<a href="#!" id="confirmYesBtn" class="modal-close waves-effect waves-green btn-flat">Yes</a>
			<a href="#!" id="confirmNoBtn" class="modal-close waves-effect waves-red btn-flat">No</a>
		</div>
	</div>

	<script>
		const vscode = window.acquireVsCodeApi();

		document.getElementById('uploadBtn').onclick = () => {
			vscode.postMessage({ command: 'upload' });
			alert('Upload button clicked!');
		};
		document.getElementById('deleteBtn').onclick = () => {
			deleteFiles();
		};
		document.getElementById('reloadBtn').onclick = () => {
			vscode.postMessage({ command: 'reload' });
		};
		document.getElementById('resetBtn').onclick = () => {
			vscode.postMessage({ command: 'reset' });
		};
		document.getElementById('exampleDropdown').onchange = function () {
			const fname = this.value;
			if (fname) {
				vscode.postMessage({ command: 'openExampleFile', filename: fname });
			}
		};
		document.getElementById('createFolderBtn').onclick = function () {
			const modalElem = document.getElementById('createFolderModal');
			const modalInstance = M.Modal.init(modalElem, { dismissible: true });
			document.getElementById('createFolderInput').value = '';
			modalInstance.open();
			document.getElementById('createFolderYesBtn').onclick = function () {
				const folderName = document.getElementById('createFolderInput').value;
				if (folderName && folderName.trim()) {
					vscode.postMessage({ command: 'createFolder', folderName: folderName.trim() });
				}
			};
			document.getElementById('createFolderNoBtn').onclick = function () {
				modalInstance.close();
			};
		};

		// Listen for messages from the extension
		window.addEventListener('message', event => {
			const message = event.data;
			if (message.command === 'showFiles') {
				document.getElementById('loader').style.display = 'none';
				document.getElementById('files').innerHTML = message.html;
				const table = document.getElementById('filesTable');
				if (table) {
					table.addEventListener('click', function (e) {
						const td = e.target.closest('td[data-fname]');
						if (td) {
							window.parent.postMessage({ command: 'openFile', filename: td.getAttribute('data-fname') }, '*');
						}
					});
				}
			} else if (message.command === 'console') {
				const consoleDiv = document.getElementById('console');
				if (consoleDiv) {
					consoleDiv.innerText += message.text + '\n';
					consoleDiv.scrollTop = consoleDiv.scrollHeight;
				}
			} else if (message.command === 'setImageUri' && message.uri) {
				/*document.body.insertAdjacentHTML('beforeend',
					`<a id="hkps-link" href="https://www.hkprog.org" target="_blank" rel="noopener" style="padding: 10px;">
						<img id="hkps-img" src="${message.uri}" alt="HKPS Eng Big Blue" style="position:fixed;bottom:24px;right:24px;width:200px;height:auto;" />
					</a>`
				);*/
				document.body.insertAdjacentHTML('beforeend',
					`<svg id="_圖層_1" data-name="圖層 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 181.42 85.04">
						<defs>
							<style>
							.cls-1 {
								fill: none;
								stroke: #ff40ff;
								stroke-width: 3px;
							}

							.cls-1, .cls-2 {
								stroke-miterlimit: 10;
							}

							.cls-3 {
								fill: #00a4ff;
							}

							.cls-2 {
								fill: #fff;
								stroke: #231916;
							}

							.cls-4 {
								fill: #ff40ff;
							}
							</style>
						</defs>
						<path class="cls-2" d="M82.72,62.72c2.83-11.34-2.54-15.73-8.76-20.82-1.67-1.36-3.55-2.91-5.14-4.57-3.97-4.16-5.94-10.21-5.32-15.98h-14.58l-9.28,7.17h-14.82l-8.47-7.17h-8.2c-1.84,0-3.34,1.5-3.34,3.34v36.81c0,1.84,1.5,3.34,3.34,3.34h9.23l8.22,6.95h14.82l9.01-6.95h32.6c.26-.67.5-1.37.69-2.11Z"/>
						<g>
							<path class="cls-4" d="M92.61,26.78h-11.14c.06,2.37.5,4.04,1.33,5.01.95,1.1,2.16,1.64,3.64,1.64,2.17,0,3.91-1.23,5.23-3.7l1.08.46c-1.62,3.14-3.95,4.72-7.01,4.72-2.08,0-3.83-.75-5.25-2.26-1.42-1.51-2.13-3.43-2.13-5.78,0-2.52.7-4.56,2.1-6.12s3.12-2.33,5.17-2.33c1.51,0,2.81.39,3.9,1.16s1.92,1.89,2.47,3.34c.39,1.02.59,2.3.61,3.85ZM81.47,25.6h6.74c.4,0,.71-.14.93-.41s.33-.73.33-1.39c0-1.22-.38-2.25-1.14-3.1s-1.65-1.28-2.68-1.28c-1.15,0-2.13.51-2.93,1.54s-1.22,2.57-1.25,4.63Z"/>
							<path class="cls-4" d="M95.98,18.89l4.45-.28c.24,1.16.4,2.26.48,3.31.84-1.21,1.69-2.07,2.53-2.56.84-.5,1.77-.74,2.78-.74,1.08,0,1.96.28,2.66.84.7.56,1.24,1.48,1.61,2.75.74-1.2,1.56-2.1,2.47-2.7.91-.6,1.9-.89,2.97-.89,1.41,0,2.48.42,3.18,1.26.91,1.11,1.36,2.53,1.36,4.28v7.72c0,.46.12.78.35.95.31.25.77.38,1.38.38h.78v1.25h-7.82v-1.25h.78c.66,0,1.13-.11,1.39-.33s.4-.55.4-1v-7.73c0-1.15-.28-2.04-.84-2.68-.56-.63-1.3-.95-2.22-.95-.7,0-1.32.19-1.89.56-.56.37-1.01.9-1.33,1.59-.47.99-.71,1.82-.71,2.51v6.7c0,.45.12.79.37,1.01s.62.32,1.13.32h1.06v1.25h-7.94v-1.25h.9c.56,0,.99-.11,1.26-.33s.42-.5.42-.85v-7.17c0-1.52-.27-2.62-.81-3.3s-1.26-1.03-2.17-1.03c-1.17,0-2.08.4-2.71,1.2-.9,1.13-1.34,2.45-1.34,3.95v6.21c0,.48.11.8.32.98.3.23.76.35,1.39.35h.8v1.25h-7.84v-1.25h1.18c.44,0,.78-.11,1.02-.33s.36-.5.36-.85v-10.19c0-.56-.14-.99-.43-1.26s-.86-.45-1.73-.53v-1.15Z"/>
							<path class="cls-4" d="M124.95,18.89l6.19-.18v13.38c0,.37.09.63.27.78.25.22.58.33.96.33h1.76v1.25h-8.85v-1.25h1.64c.49,0,.84-.12,1.07-.36s.34-.58.34-1.04v-9.8c0-.62-.18-1.09-.53-1.4s-.88-.47-1.58-.47h-1.28v-1.25ZM129.27,9.61c.5,0,.94.19,1.31.56s.56.82.56,1.33-.18.93-.55,1.3-.8.55-1.31.55-.95-.19-1.32-.56-.56-.81-.56-1.3.19-.94.56-1.31.81-.56,1.3-.56Z"/>
						</g>
						<path class="cls-1" d="M87.36,6.1c-4.97-.93-9.48-.35-13.41,1.74-7.49,3.98-9.82,9.53-10.46,13.47-.88,5.42.91,11.23,4.66,15.16,1.48,1.56,3.24,3,4.95,4.39,6.21,5.08,12.63,10.34,9.47,22.98-2.73,10.95-13.44,15.21-21.78,15.52l-.13-.02"/>
						<g>
							<path class="cls-3" d="M101.31,42.87v11.57c.65-.92,1.38-1.61,2.18-2.07.8-.46,1.67-.68,2.61-.68,1.83,0,3.37.71,4.63,2.14s1.89,3.31,1.89,5.65c0,2.53-.68,4.58-2.03,6.13s-3.04,2.33-5.04,2.33c-.95,0-1.82-.19-2.59-.56s-1.57-1.01-2.39-1.91c-.63,1.01-1.24,1.83-1.83,2.47l-.66-.23c.31-1.27.46-2.6.46-3.98v-17.58c0-.54-.19-.97-.57-1.28s-.92-.46-1.62-.46h-.7v-1.25l5.66-.28ZM105.49,53.16c-1.25,0-2.27.54-3.06,1.63-.79,1.09-1.18,2.89-1.18,5.4s.39,4.1,1.16,5.12,1.79,1.54,3.04,1.54c1.13,0,2.04-.51,2.72-1.53.86-1.28,1.3-3.11,1.3-5.49s-.38-4.04-1.14-5.1c-.76-1.06-1.71-1.58-2.85-1.58Z"/>
							<path class="cls-3" d="M121.28,42.87v22.55c0,.31.09.55.28.71.28.22.61.33,1.01.33h1.64v1.25h-8.82v-1.25h1.56c.51,0,.89-.12,1.14-.37s.37-.59.37-1.03v-18.93c0-.55-.15-.96-.45-1.21-.41-.35-.91-.53-1.51-.53h-1.39v-1.25l6.16-.28Z"/>
							<path class="cls-3" d="M133.45,51.68c2.09,0,3.85.76,5.27,2.27s2.13,3.5,2.13,5.97c0,1.7-.32,3.16-.95,4.36s-1.54,2.15-2.72,2.85-2.45,1.05-3.81,1.05c-2.01,0-3.72-.76-5.12-2.29s-2.1-3.51-2.1-5.94.7-4.43,2.11-5.96c1.41-1.53,3.14-2.29,5.2-2.29ZM133.45,52.86c-1.24,0-2.26.56-3.06,1.69s-1.2,2.9-1.2,5.32.4,4.27,1.19,5.41,1.81,1.71,3.06,1.71,2.34-.57,3.15-1.71,1.2-3.01,1.2-5.6c0-2.4-.4-4.14-1.19-5.21s-1.85-1.61-3.16-1.61Z"/>
							<path class="cls-3" d="M155,63.09l1.08.32c-.86,3.18-2.77,4.77-5.71,4.77-2.16,0-3.92-.71-5.3-2.14-1.37-1.43-2.06-3.33-2.06-5.69,0-2.75.75-4.87,2.26-6.38s3.28-2.27,5.31-2.27c1.53,0,2.79.42,3.79,1.26s1.49,1.78,1.49,2.81c0,.62-.19,1.13-.56,1.54s-.81.61-1.32.61-.92-.17-1.26-.51-.51-.76-.51-1.24.19-.95.56-1.39c.18-.21.27-.37.27-.5,0-.32-.22-.63-.65-.93-.43-.3-1.02-.46-1.76-.46-1.35,0-2.37.49-3.07,1.47-1,1.43-1.49,3.31-1.49,5.64s.44,3.9,1.33,5.05,2.01,1.72,3.39,1.72c1.89,0,3.3-1.22,4.22-3.65Z"/>
							<path class="cls-3" d="M157.94,43.15l5.94-.28v16.99l5.06-4.41c.49-.43.73-.81.73-1.13,0-.28-.14-.49-.43-.64-.43-.22-1.13-.34-2.1-.36v-1.16h8.29v1.16c-1.64.09-2.89.52-3.75,1.3l-3.58,3.16,5.8,7.98c.35.48.97.71,1.84.71h.86v1.25h-8.5v-1.25h.85c.63,0,1.05-.06,1.27-.17s.32-.24.32-.4-.06-.31-.17-.46l-4.23-5.93-2.26,2v3.93c0,.32.11.56.32.71.3.21.71.32,1.25.32h1.08v1.25h-8.35v-1.25h1.34c.55,0,.96-.12,1.23-.35s.4-.54.4-.93v-19.19c0-.5-.16-.86-.48-1.1-.46-.33-1.09-.5-1.88-.5h-.85v-1.25Z"/>
						</g>
					</svg>`
				);
			} else if (message.command === 'setImageUri2' && message.uri) {
				/*document.body.insertAdjacentHTML('beforeend',
					`<a id="hkps-link" href="https://semiblock.hkprog.org" target="_blank" rel="noopener" style="padding: 10px;">
						<img id="hkps-img" src="${message.uri}" alt="Semiblock" style="position:fixed;bottom:24px;right:250px;height:80px;" />
					</a>`
				);*/
				// document.body.insertAdjacentHTML('beforeend',
				// 	`<a id="hkps-link" href="https://semiblock.hkprog.org" target="_blank" rel="noopener" style="padding: 10px;">
				// 		<img id="hkps-img" src="assets/image/semiblock.svg" alt="Semiblock" style="position:fixed;bottom:24px;right:250px;height:80px;" />
				// 	</a>`
				// );
			} else if (message.command === 'renderBreadcrumb') {
				const breadcrumb = document.querySelector('#breadcrumbDiv');
				if (breadcrumb) {
					breadcrumb.innerHTML = '';
					const parts = message.currentFolder.split('/').filter(Boolean);
					let pathSoFar = '';
					// Add root
					const rootItem = document.createElement('a');
					rootItem.className = 'breadcrumb';
					rootItem.textContent = '/';
					rootItem.style.cursor = 'pointer';
					rootItem.onclick = () => {
						vscode.postMessage({ command: 'changeFolder', folder: '/' });
						vscode.postMessage({ command: 'reload' });
					};
					breadcrumb.appendChild(rootItem);
					// Add each folder part
					parts.forEach((part, index) => {
						pathSoFar += '/' + part;
						const item = document.createElement('a');
						item.className = 'breadcrumb';
						item.textContent = part;
						item.style.cursor = 'pointer';

						let temp = pathSoFar;
						if (index !== parts.length - 1) {
							item.onclick = () => {
								vscode.postMessage({ command: 'changeFolder', folder: temp });
								vscode.postMessage({ command: 'reload' });
							};
						}
						breadcrumb.appendChild(item);
					});
				}
			}
		});

		function tableClicked(filename) {
			vscode.postMessage({ command: 'openFile', filename });
		}

		// Show custom rename modal
		function renameFile(filename) {
			showRenameModal(filename, (newName) => {
				if (newName && newName !== filename) {
					vscode.postMessage({ command: 'renameFile', oldName: filename, newName });
				}
			});
		}

		function deleteFiles() {
			const selectedFiles = Array.from(document.querySelectorAll('#filesTable input[type="checkbox"]:checked'))
				.map(checkbox => checkbox.getAttribute('data-fname'));
			if (selectedFiles.length === 0) {
				showConfirm('No files selected for deletion.', null, null);
				return;
			}
			showConfirm(
				`Are you sure you want to delete the following files?\n\n${selectedFiles.join('\n')}`,
				() => vscode.postMessage({ command: 'deleteFile', files: selectedFiles }),
				() => { }
			);
		}

		// Show Materialize confirmation modal
		function showConfirm(message, onYes, onNo) {
			document.getElementById('confirmMessage').textContent = message;
			const modalElem = document.getElementById('confirmModal');
			const modalInstance = M.Modal.init(modalElem, { dismissible: false });
			modalInstance.open();
			const yesBtn = document.getElementById('confirmYesBtn');
			const noBtn = document.getElementById('confirmNoBtn');
			yesBtn.onclick = () => {
				modalInstance.close();
				if (onYes) onYes();
			};
			noBtn.onclick = () => {
				modalInstance.close();
				if (onNo) onNo();
			};
		}

		// Custom modal for renaming files (unchanged)
		function showRenameModal(filename, onRename) {
			let modal = document.getElementById('renameModal');
			if (!modal) {
				modal = document.createElement('div');
				modal.id = 'renameModal';
				modal.style.position = 'fixed';
				modal.style.top = '0';
				modal.style.left = '0';
				modal.style.width = '100vw';
				modal.style.height = '100vh';
				modal.style.background = 'rgba(0,0,0,0.3)';
				modal.style.zIndex = '1001';
				modal.style.display = 'flex';
				modal.style.justifyContent = 'center';
				modal.style.alignItems = 'center';
				modal.innerHTML = `
					<div style="background:#fff;padding:24px;border-radius:8px;min-width:300px;box-shadow:0 2px 8px #0002;text-align:center;">
						<div style="margin-bottom:16px;">Rename <b>${filename}</b> to:</div>
						<input id="renameInput" type="text" value="${filename}" style="width:80%;padding:8px;margin-bottom:16px;" />
						<br />
						<button id="renameYesBtn" style="margin-right:16px;">Rename</button>
						<button id="renameNoBtn">Cancel</button>
					</div>
				`;
				document.body.appendChild(modal);
			} else {
				modal.style.display = 'flex';
				modal.querySelector('#renameInput').value = filename;
			}
			const yesBtn = modal.querySelector('#renameYesBtn');
			const noBtn = modal.querySelector('#renameNoBtn');
			yesBtn.onclick = () => {
				const newName = modal.querySelector('#renameInput').value;
				modal.style.display = 'none';
				if (onRename) onRename(newName);
			};
			noBtn.onclick = () => {
				modal.style.display = 'none';
			};
		}

		// Initialize Materialize select and modal on DOMContentLoaded
		document.addEventListener('DOMContentLoaded', function () {
			var elems = document.querySelectorAll('select');
			M.FormSelect.init(elems);
			var modals = document.querySelectorAll('.modal');
			M.Modal.init(modals);
		});
	</script>
</body>

</html>