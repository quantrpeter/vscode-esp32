<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>MicroPython Device Files</title>
	<style>
		body {
			font-family: sans-serif;
			padding: 16px;
		}

		.toolbar {
			display: flex;
			gap: 10px;
			margin-bottom: 16px;
		}

		.toolbar button {
			padding: 6px 16px;
			font-size: 1em;
			cursor: pointer;
			border-radius: 4px;
			border: 1px solid var(--vscode-button-border, #ccc);
			background: var(--vscode-button-background, #f3f3f3);
			color: var(--vscode-button-foreground, inherit);
			transition: background 0.2s;
		}

		.toolbar button:hover {
			background: var(--vscode-button-hoverBackground, #e0e0e0);
		}

		.loader {
			display: flex;
			justify-content: center;
			align-items: center;
			height: 80px;
		}

		/* Add a custom modal for confirmation */
		#confirmModal {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100vw;
			height: 100vh;
			background: rgba(0, 0, 0, 0.3);
			z-index: 1000;
			justify-content: center;
			align-items: center;
		}

		#confirmModal>div {
			background: #fff;
			padding: 24px;
			border-radius: 8px;
			min-width: 300px;
			box-shadow: 0 2px 8px #0002;
			text-align: center;
		}

		#console {
			background-color: black;
			color: white;
			overflow: auto;
		}
	</style>
</head>

<body>
	<div class="toolbar">
		<button id="uploadBtn">Upload</button>
		<button id="deleteBtn"">Delete</button>
		<button id="reloadBtn">Reload</button>
		<button id="resetBtn">Reset</button>
		
		<select id="exampleDropdown" style="margin-left:16px;padding:6px 12px;">
			<option value="">Select example file...</option>
			<option value="animation.py">animation.py</option>
			<option value="scanI2C.py">scanI2C.py</option>
			<option value="servo.py">servo.py</option>
			<option value="test.py">test.py</option>
			<option value="touch.py">touch.py</option>
		</select>
	</div>
	<h2>Files on device</h2>
	<div id="loader" class="loader">
	</div>
	<div id="files"></div>
	<h2>Console</h2>
	<div id="console"></div>

	<!-- Add a custom modal for confirmation -->
	<div id="confirmModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.3);z-index:1000;justify-content:center;align-items:center;">
		<div style="background:#fff;padding:24px;border-radius:8px;min-width:300px;box-shadow:0 2px 8px #0002;text-align:center;">
			<div id="confirmMessage" style="margin-bottom:16px;">Are you sure?</div>
			<button id="confirmYesBtn" style="margin-right:16px;">Yes</button>
			<button id="confirmNoBtn">No</button>
		</div>
	</div>

	<script>
		const vscode = window.acquireVsCodeApi();

		document.getElementById('uploadBtn').onclick = () => {
			vscode.postMessage({ command: 'upload' });
			alert('Upload button clicked!');
		};
		document.getElementById('deleteBtn').onclick = () => {
			deleteFiles();
		};
		document.getElementById('reloadBtn').onclick = () => {
			vscode.postMessage({ command: 'reload' });
		};
		document.getElementById('resetBtn').onclick = () => {
			vscode.postMessage({ command: 'reset' });
		};
		document.getElementById('exampleDropdown').onchange = function () {
			const fname = this.value;
			if (fname) {
				vscode.postMessage({ command: 'openExampleFile', filename: fname });
			}
		};

		// Listen for messages from the extension
		window.addEventListener('message', event => {
			const message = event.data;
			if (message.command === 'showFiles') {
				console.log('showFiles event');
				// Hide loader
				document.getElementById('loader').style.display = 'none';
				// Show files table
				document.getElementById('files').innerHTML = message.html;
				console.log('files', document.getElementById('files'));
				console.log('message.html', message.html);
				// Add click handler to table rows
				const table = document.getElementById('filesTable');
				if (table) {
					table.addEventListener('click', function (e) {
						const td = e.target.closest('td[data-fname]');
						if (td) {
							window.parent.postMessage({ command: 'openFile', filename: td.getAttribute('data-fname') }, '*');
						}
					});
				}
			} else if (message.command === 'console') {
				console.log('console', message.text);
				const consoleDiv = document.getElementById('console');
				if (consoleDiv) {
					consoleDiv.innerText += message.text + '\n';
					consoleDiv.scrollTop = consoleDiv.scrollHeight;
				}
			} else if (message.command === 'setImageUri' && message.uri) {
				console.log('fuck', message.uri);
				document.body.insertAdjacentHTML('beforeend',
					`<a id="hkps-link" href="https://www.hkprog.org" target="_blank" rel="noopener" style="padding: 10px;">
						<img id="hkps-img" src="${message.uri}" alt="HKPS Eng Big Blue" style="position:fixed;bottom:24px;right:24px;width:200px;height:auto;" />
					</a>`
				);
			} 
			else if (message.command === 'setImageUri2' && message.uri) {
				document.body.insertAdjacentHTML('beforeend',
					`<a id="hkps-link" href="https://semiblock.hkprog.org" target="_blank" rel="noopener" style="padding: 10px;">
						<img id="hkps-img" src="${message.uri}" alt="Semiblock" style="position:fixed;bottom:24px;right:250px;height:80px;" />
					</a>`
				);
			}
		});

		function tableClicked(filename) {
			console.log('Table row clicked:', filename);
			vscode.postMessage({ command: 'openFile', filename });
		}

		// Show custom rename modal
		function renameFile(filename) {
			showRenameModal(filename, (newName) => {
				if (newName && newName !== filename) {
					vscode.postMessage({ command: 'renameFile', oldName: filename, newName });
				}
			});
		}

		// Custom modal for renaming files
		function showRenameModal(filename, onRename) {
			// Create modal if not exists
			let modal = document.getElementById('renameModal');
			if (!modal) {
				modal = document.createElement('div');
				modal.id = 'renameModal';
				modal.style.position = 'fixed';
				modal.style.top = '0';
				modal.style.left = '0';
				modal.style.width = '100vw';
				modal.style.height = '100vh';
				modal.style.background = 'rgba(0,0,0,0.3)';
				modal.style.zIndex = '1001';
				modal.style.display = 'flex';
				modal.style.justifyContent = 'center';
				modal.style.alignItems = 'center';
				modal.innerHTML = `
					<div style="background:#fff;padding:24px;border-radius:8px;min-width:300px;box-shadow:0 2px 8px #0002;text-align:center;">
						<div style="margin-bottom:16px;">Rename <b>${filename}</b> to:</div>
						<input id="renameInput" type="text" value="${filename}" style="width:80%;padding:8px;margin-bottom:16px;" />
						<br />
						<button id="renameYesBtn" style="margin-right:16px;">Rename</button>
						<button id="renameNoBtn">Cancel</button>
					</div>
				`;
				document.body.appendChild(modal);
			} else {
				modal.style.display = 'flex';
				modal.querySelector('#renameInput').value = filename;
			}
			// Set up button handlers
			const yesBtn = modal.querySelector('#renameYesBtn');
			const noBtn = modal.querySelector('#renameNoBtn');
			yesBtn.onclick = () => {
				const newName = modal.querySelector('#renameInput').value;
				modal.style.display = 'none';
				if (onRename) onRename(newName);
			};
			noBtn.onclick = () => {
				modal.style.display = 'none';
			};
		}

		function deleteFiles() {
			const selectedFiles = Array.from(document.querySelectorAll('#filesTable input[type="checkbox"]:checked'))
				.map(checkbox => checkbox.getAttribute('data-fname'));
			if (selectedFiles.length === 0) {
				showConfirm('No files selected for deletion.', null, null);
				return;
			}
			showConfirm(
				`Are you sure you want to delete the following files?\n\n${selectedFiles.join('\n')}`,
				() => vscode.postMessage({ command: 'deleteFile', files: selectedFiles }),
				() => { }
			);
		}

		// Show custom confirmation modal
		function showConfirm(message, onYes, onNo) {
			document.getElementById('confirmMessage').textContent = message;
			document.getElementById('confirmModal').style.display = 'flex';
			const yesBtn = document.getElementById('confirmYesBtn');
			const noBtn = document.getElementById('confirmNoBtn');
			yesBtn.onclick = () => {
				document.getElementById('confirmModal').style.display = 'none';
				if (onYes) onYes();
			};
			noBtn.onclick = () => {
				document.getElementById('confirmModal').style.display = 'none';
				if (onNo) onNo();
			};
		}
	</script>
</body>

</html>